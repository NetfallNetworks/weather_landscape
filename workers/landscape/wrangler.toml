# Landscape Generator Worker Configuration
# Deploy from workers/landscape/ directory with: uv run pywrangler deploy

name = "landscape-generator"
main = "src/landscape_generator.py"
compatibility_date = "2025-01-10"
compatibility_flags = ["python_workers"]

# Enable workers.dev for testing (can be disabled in production)
workers_dev = false

# Smart Placement - Note: doesn't affect queue consumers, but enabled anyway
# Queue consumers run where the queue fires, which is consistently WNAM
[placement]
mode = "smart"

# Workers Logs - enables log collection for visibility during runs
[observability.logs]
enabled = true
head_sampling_rate = 1
persist = true
invocation_logs = true

[observability.traces]
enabled = true
head_sampling_rate = 1
persist = true

# Bundle image files as Data modules so Python can access them
[[rules]]
type = "Data"
globs = ["**/*.bmp", "**/*.png", "**/*.jpg", "**/*.jpeg"]
fallthrough = true

# R2 Bucket Binding - stores generated weather landscape images
# PERFORMANCE: Bucket created with location=wnam hint for optimal performance
# This eliminates cross-region latency (~1.7s â†’ ~100-300ms)
[[r2_buckets]]
binding = "WEATHER_IMAGES"
bucket_name = "weather-landscapes"

# KV Namespace Binding - stores configuration and metadata
# Note: YOUR_KV_NAMESPACE_ID is a placeholder kept in git
# For local development, run: ./setup-local-config.sh
# Then deploy with: wrangler deploy -c workers/landscape/wrangler.local.toml
[[kv_namespaces]]
binding = "CONFIG"
id = "YOUR_KV_NAMESPACE_ID"

# Queue Consumer Binding - receives jobs from job dispatcher
[[queues.consumers]]
queue = "landscape-jobs"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "landscape-jobs-dlq"

# Environment Variables
[vars]
DEFAULT_ZIP = "78729"

# Note: OWM_API_KEY needed for OpenWeatherMap class initialization
# (even though generator uses pre-fetched weather data from KV)
# Set with: wrangler secret put OWM_API_KEY -c workers/landscape/wrangler.toml
